<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
    <script src="leaflet-heat.js"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }

        .legend {
            line-height: 36px;
            color: #555;
            background: rgba(255, 255, 255, 0.3);
        }
        .legend i {
            width: 36px;
            height: 36px;
            float: left;
            margin-right: 16px;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        function getColor(d) {
            return d > 100 ? '#FF0000' :
                   d > 75  ? '#FFA500' :
                   d > 50  ? '#00FF00' :
                              '#00BFFF';
        }

        var map = L.map('map').setView([43.53959, 76.90979], 15);
        var assetLayerGroup = new L.LayerGroup().addTo(map);
        L.tileLayer('http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.jpg').addTo(map);
        map.options.minZoom = 10;
        map.options.maxZoom = 20;

        var legend = L.control({position: 'topright'});

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 50, 75, 100],
                labels = [];

                for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }

            return div;
        };

        legend.addTo(map);


        function click(e){
            console.log(e.target._zoom);
            var coord = e.latlng.toString().split(',');
            var lat = coord[0].split('(');
            var lng = coord[1].split(')');
            console.log("You clicked the map at latitude: " + lat[1] + " and longitude:" + lng[0]);

            const xhr = new XMLHttpRequest();

            xhr.open("GET", ("http://127.0.0.1:8000/getcar/MX1CEBCB0MK176800/"+lat[1]+"/"+lng[0]+"/"+e.target._zoom).replace(" ",""));
            xhr.setRequestHeader("Access-Control-Allow-Origin", "http://127.0.0.1:8000");
            xhr.send();
            xhr.responseType = "json";
            xhr.onload = () => {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    data = JSON.parse(xhr.response);
                    console.log(data);

                    assetLayerGroup.clearLayers();

                    var heat = L.heatLayer(data, {radius: 25, gradient:{0.25: 'blue', 0.5: 'lime', 0.7: 'orange', 1:'red'}});
                    assetLayerGroup.addLayer(heat);
                }
                else {
                    console.log(`Error: ${xhr.status}`);
                }
            };

        };

        map.on('mousedown', click);
    </script>
</body>